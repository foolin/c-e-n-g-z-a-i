@{
    ViewBag.Title = "上传头像-";
    var user = Html.GetLoginUser();
    var imgPath = CengZai.Helper.Config.UploadHttpPath + "/" + user.Avatar;
}
@section head{
    <script src="@Url.Content("~/js/swfupload/swfupload.js")" type="text/javascript"></script>
    <script type="text/javascript">
        var swfu;

        function uploadError(file, errorCode, message) {
            var errDesc = message;

            switch (errorCode) {
		    case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:
                errDesc = "";
			    break;
		    case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:
                break;
		    case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:
			    break;
            
            case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:
                errDesc = "您上传文件太多喇！";
			    break;
		    case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:
                errDesc = "您上传文件太小！";
			    break;
		    case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:
                errDesc = "您上传文件太大！";
			    break;
		    case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:
                errDesc = "您上传文件格式不对！";
                break;
		    default:
			    break;
		    }

            alert('错误：' + errDesc);
        }

        SWFUpload.onload = function () {
            var settings = {
                flash_url: "/js/swfupload/swfupload.swf",
                flash9_url: "/js/swfupload/swfupload_fp9.swf",
                upload_url: "/Settings/UploadAvatar",
                file_post_name: "fileAvatar",
                post_params: {
                    "ASPSESSID": "@Session.SessionID",
                },

                // File Upload Settings
                file_size_limit: "1 MB",
                file_types: "*.jpg",
                file_types_description: "JPG Images",
                file_upload_limit: 0,    // Zero means unlimited
                file_queue_limit: 1,
                debug: false,
                button_window_mode: SWFUpload.WINDOW_MODE.TRANSPARENT,

                // Button Settings
                button_image_url: "/img/upload-photo.png",
                button_placeholder_id: "divUploadAvatar",
                button_width: 160,
                button_height: 38,
                //button_text: '<span class="button">上传图片 <span class="buttonSmall"></span></span>',
                //button_text_style: '.button { font-family: Helvetica, Arial, sans-serif; font-size: 14pt; } .buttonSmall { font-size: 10pt; }',
                button_text_top_padding: 1,
                button_text_left_padding: 5,

                //点击上传
                file_dialog_complete_handler: function (numFilesSelected, numFilesQueued) {
                    try {
                        if (numFilesQueued > 0) {
                            this.addPostParam("avatar",$("#avatar").val());
                            this.startUpload();
                            $("#tips-avatar").html("正在上传...");
                        }
                    } catch (ex) {
                        this.debug(ex);
                    }
                },
                upload_error_handler : uploadError,
                file_queue_error_handler: uploadError,
			    upload_success_handler :  function(file, serverData) {
	                try {
                        var data = eval('(' + serverData + ')');
                        if(data.id == 1){
                            $("#avatar").val(data.msg);
                            var showUrl =  '@CengZai.Helper.Config.UploadHttpPath/' + data.msg;
                            $("#imgAvatar").attr("src",  showUrl);
                            $("#imgAvatar").css("display","block");
                            $("#tips-avatar").html("上传完毕");;
                        }
                        else
                        {
                            $("#tips-avatar").html(data.msg);;
                            alert(data.msg);
                        }
                    
	                } catch (ex) {
                        alert('上传图片出现异常，请稍后再试');
                        console.log(ex);
		                this.debug(ex);
	                }
                },
                upload_complete_handler: function(file) {
                    try {
                        /*  I want the next upload to continue automatically so I'll call startUpload here */
                    } catch (ex) {
                        this.debug(ex);
                    }
                },
            };


            swfu = new SWFUpload(settings);
        }
    </script>
}

<div class="container bg-white">
<div class="padding">
    <h2>@ViewBag.Title</h2>
    <br />
    @Html.Partial("_SettingNav", new { Active = "Avatar" })
 
    <div class="tab-content">
        <div class="tab-pane active">
            <div class="control-group">
                <label class="control-label" for="oldpassword">当前头像：</label>
                <div class="controls">
                    <p>
                        <img id="imgAvatar" class="thumbnail" width="200" src="@imgPath" alt="当前头像" />
                        @Html.Hidden("avartar", @user.Avatar)
                    </p>
                    <div id="divUploadAvatar"></div>
                     <span class="field-validation-error" data-valmsg-for="avatar" id="tips-avatar" data-valmsg-replace="true"></span>
                    <p class="help-block">请上传一张图像</p>

                </div>
            </div>
        </div>
    </div>

</div>
</div>   
<!--/.container -->
